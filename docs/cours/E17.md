# E17

## challenge Event : MaintenanceSubcriber

[Listener vs subscriber](https://symfony.com/doc/5.4/event_dispatcher.html#listeners-or-subscribers)

Subscriber se suffit Ã  lui mÃªme, tout en un

Listener doit Ãªtre configurÃ© dans services.yaml

### notre subscriber

Objectif : afficher un message d'alerte sur toutes les pages

Comment mettre du html sur toutes les pages sans passer par twig ?

Pour afficher quelque chose dans toutes les pages, on peut d'inspirer de ce qui [est fait pour 'injecter' la toolbar de profiler.](https://github.com/symfony/web-profiler-bundle/blob/c779222d5a87b7d947e56ac09b02adb34cf8b610/EventListener/WebDebugToolbarListener.php#L137)

On remarque de suite que c'est un [KernelEvent](https://github.com/symfony/web-profiler-bundle/blob/c779222d5a87b7d947e56ac09b02adb34cf8b610/EventListener/WebDebugToolbarListener.php#L162)

Chouette, on sait faire les subscriber. ğŸ˜

```bash
bin/console make:subscriber
```

On choisit `Kernel.response` comme on l'a vu dans le code de la barre de profiler.

Mais ensuite ğŸ¤” ?
le code de la barre de profiler n'est pas trÃ¨s explicite ğŸ˜…

RÃ©flÃ©chissons, on est sur l'event `response`, on a donc accÃ¨s Ã  la rÃ©ponse HTML juste avant qu'elle soit envoyÃ©e.
Si on modifiait le contenu du HTML ? un peu comme en JS on manipule le DOM.

Pour Ã§a on veut obtenir quoi ?
une balise `<div class="alert alert-danger m-3">Maintenance prÃ©vue jeudi 25 mai Ã  17h00</div>` mais oÃ¹ ?

C'est subjectif, mais choissisons un endroit visible ğŸ¤“, disons juste aprÃ¨s la `<nav>`

On va donc rechercher la `nav` dans le contenu de la page, que l'on obtient avec le `ResponseEvent` passÃ© en paramÃ¨tre.

On y insÃ¨re notre message juste aprÃ¨s.

```php
// la rÃ©ponse HTTP
$response = $event->getResponse();
// le contenu HTML
$content = $response->getContent();
// On ajoute le code de la banniÃ¨re aprÃ¨s la balise nav du contenu HTML
$newHtml = str_replace(
    // Qu'est-ce qu'on cherche ?
    '</nav>',
    // Par quoi on remplace ?
    '</nav><div class="alert alert-danger m-3">Maintenance prÃ©vue jeudi 25 mai Ã  17h00</div>',
    // Dans quelle chaine ?
    $content
);
// On assigne le nouveau contenu Ã  la rÃ©ponse
$response->setContent($newHtml);

// /!\ Nul besoin de retourner quoique ce soit ou d'appeler une mÃ©thode spÃ©cifique
// l'objet $reponse a Ã©tÃ© manipulÃ© directement et sera envoyÃ© par le Kernel
```

[doc](https://symfony.com/doc/5.4/event_dispatcher.html#creating-an-event-subscriber)

### paramÃ©trage d'un service/subscriber

#### 1 Ã¨re Ã©tape : modifier le code pour gÃ©rer la conditionnalitÃ©

on crÃ©er une propriÃ©tÃ©, que l'on change selon nos besoins

```php
// private $maintenanceActive = true;

if (!$this->maintenanceActive){
    // la maintenance est dÃ©sactivÃ©
    // on s'arrÃªte lÃ 
    return;
}
```

Ã§a fonctionne, mais on doit changer le code pour activer/dÃ©sactiver la fonctionnalitÃ©

#### 2 Ã¨me Ã©tape : rendre le service/subscriber paramÃ©trable dans le fichier services.yaml

on rend notre service paramÃ©trable en ajoutant un constructeur avec des arguments

```php
/**
 * @param bool $argMaintenanceActive paramÃ©trable dans le fichier services.yaml
 */
public function __construct($argMaintenanceActive)
{
    $this->maintenanceActive = $argMaintenanceActive;
}
```

dans le fichier services.yaml, on prÃ©cise la valeur des arguments

```yaml
    # Pour paramÃ©trer un service je dois fournir le FQCN du service
    App\EventSubscriber\MaintenanceSubscriber:
        # on explique que notre service a des arguments
        arguments:
            # on prÃ©cise alors le nom de l'argument
            # ainsi que la valeur qu'il va avoir
            $argMaintenanceActive: true
```

#### 3 Ã¨me Ã©tape : le faire depuis le fichier .env

l'objectif est de se servir du fichier `.env` comme ceci:

```ini
###> MaintenanceSubscriber ###
MAINTENANCE_ACTIVE=true
###< MaintenanceSubscriber ###
```

pour cela on modifie le fichier `services.yaml` en prÃ©cisant le nom du paramÃ¨tre Ã  lire dans le fichier `.env`

**ATTENTION** au type de donnÃ©e car on lisant le fichier `.env` tout est chaine de caractÃ¨re.
Par exemple si on veux un boolÃ©en, la chaine 'false' ne sera pas comprise comme la valeur `false`

[doc](https://symfony.com/doc/current/configuration/env_var_processors.html#built-in-environment-variable-processors)

```yaml
    # Pour paramÃ©trer un service je dois fournir le FQCN du service
    App\EventSubscriber\MaintenanceSubscriber:
        # on explique que notre service a des arguments
        arguments:
            # on prÃ©cise alors le nom de l'argument
            # ainsi que la valeur qu'il va avoir
            $argMaintenanceActive: '%env(bool:MAINTENANCE_ACTIVE)%'
```

## API



### API : GET

### API : POST/PUT/PATCH

### API : DELETE
